<!DOCTYPE HTML>
<html xmlns:v-on="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <script type="text/javascript" src="../lib/html5shiv.js"></script>
    <script type="text/javascript" src="../lib/respond.min.js"></script>
    <link href="../static/h-ui/css/H-ui.min.css" rel="stylesheet" type="text/css"/>
    <link href="../static/h-ui.admin/css/H-ui.admin.css" rel="stylesheet" type="text/css"/>
    <link href="../lib/Hui-iconfont/1.0.8/iconfont.css" rel="stylesheet" type="text/css"/>
    <link href="../lib/jquery-easyui-1.7.0/themes/default/easyui.css" rel="stylesheet" type="text/css"/>
    <link href="../lib/jquery-easyui-1.7.0/themes/icon.css" rel="stylesheet" type="text/css"/>
    <link href="../static/css/style.css" rel="stylesheet" type="text/css"/>
    <link href="../lib/imageLabel/styles/jquery.imageLabel.min.css" rel="stylesheet"/>
    <link href="../lib/imageLabel/styles/edit.css" rel="stylesheet"/>
    <title>新增专题</title>
</head>
<body>
<div class="pd-20" id="special">
    <nav class="breadcrumb infoNode"><i class="Hui-iconfont">&#xe67f;</i> 首页 <span class="c-gray en">&gt;</span> 活动管理 <span class="c-gray en">&gt;</span> 新增专题 </nav>
    <div class="row cl form-div infoNode">
        <div class="one-half">
            <label>专题标题：</label>
            <input type="text" class="input-text" value="" placeholder="" id="title" name="title" onkeyup="titleAbbr.value = Pinyin.GetJP(this.value)"/>
        </div>
        <div class="one-half">
            <label>标题简拼：</label>
            <input type="text" class="input-text" value="" placeholder="" id="titleAbbr" name="titleAbbr">
        </div>
    </div>
    <div class="row cl form-div infoNode">
        <div class="one-quarter">
            <label>运营商：</label>
            <span class="select-box small-box">
                <select class="select" id="isp">
                    <option value="1">电信</option>
                    <option value="2" selected>广电</option>
                </select>
            </span>
        </div>
        <div class="one-quarter">
            <label>环境：</label>
            <span class="select-box small-box">
                <select class="select" id="active">
                    <option value="test" selected>测试环境</option>
                    <option value="prod">生产环境</option>
                </select>
            </span>
        </div>
        <div class="one-quarter">
            <label>专题类型：</label>
            <span class="select-box small-box">
                <select class="select" id="ctype">
                    <option value="0">不推荐</option>
                    <option value="1" selected>最新</option>
                    <option value="2">儿童</option>
                    <option value="3">明星</option>
                    <option value="4">节日</option>
                </select>
            </span>
        </div>
        <div class="one-quarter">
            <label>专题页排序：</label>
            <input type="text" class="easyui-numberbox" value="0" placeholder="" id="csort" name="csort">
        </div>
    </div>
    <div class="row cl form-div-center infoNode">
        <button onclick="add('song');" class="btn btn-secondary radius" type="button"> 添加歌曲</button>
        <button onclick="add('btn');" class="btn btn-secondary radius" type="button"> 添加按钮</button>
    </div>
    <div class="div-add radius form-div infoNode" id="div-add-song" hidden="hidden">
        <ul>
            <li>
                <span>
                    <label>歌曲： </label>
                      <input class="easyui-combobox" id="songSelect" style="width:300px"/>
                </span>
                <span>
                    <label>是否免费： </label>
                    <input type="radio" name="isFree" value="0" checked> 否
                    <input type="radio" name="isFree" value="1"> 是
                </span>
            </li>
<!--            <li>-->
<!--                <span>-->
<!--                    <label>节点信息： </label>-->
<!--                    <span onclick="changeInput(1)"><input type="radio" name="type" value="1" checked/> 手动输入</span>-->
<!--                    <span onclick="changeInput(0)"><input type="radio" name="type" value="0"/> 添加标注</span>-->
<!--                    </span>-->
<!--                </span>-->
<!--            </li>-->
            <li class="manual">
                <span>
                    <label>节点 - 宽度： </label>
                    <input type="text" class="easyui-numberbox" value="" placeholder="" id="songNodeWidth" name="width">
                </span>
                <span>
                    <label>节点 - 高度： </label>
                    <input type="text" class="easyui-numberbox" value="" placeholder="" id="songNodeHeight" name="height">
                </span>
            </li>
            <li class="manual">
                <span>
                    <label>节点 - 左边距： </label>
                    <input type="text" class="easyui-numberbox" value="" placeholder="" id="songNodeLeft" name="left">
                </span>
                <span>
                    <label>节点 - 上边距： </label>
                    <input type="text" class="easyui-numberbox" value="" placeholder="" id="songNodeTop" name="top">
                </span>
            </li>
            <li class="manual">
                <span>
                    <label>节点 - 图片： </label>
                    <input type="text" class="input-text small-box" value="" placeholder="" id="songNodeImg" name="img">
                </span>
            </li>
            <li class="automatic" hidden>
                <span>
                    <label>选择图片： </label>
                    <input type="hidden" id="songImg"/>
                    <span class="btn-upload form-group">
                        <input class="input-text upload-url" type="text" name="uploadfile-2" readonly style="width:200px">
                        <input type="file" multiple name="file-2" class="input-file" onchange="choosedFile(this, 'song')">
                        <a href="javascript:void();" class="btn btn-primary upload-btn"><i class="Hui-iconfont">&#xe642;</i> 选择图片</a>
                        <button type="button" class="btn btn-default radius" style="z-index: 3;" onclick="startTag()"> 开始标注 </button>
                    </span>
                </span>
            </li>
            <li>
                <button onclick="complete('song');" class="btn btn-success radius" type="button"> 完成</button>
                <button onclick="closeDiv('song');" class="btn btn-default radius" type="button"> 关闭</button>
            </li>
        </ul>
    </div>
    <div class="div-add radius form-div infoNode" id="div-add-btn" hidden="hidden">
        <ul>
            <li>
                <span>
                    <label>按钮类型： </label>
                    <span class="select-box small-box">
                        <select class="select" id="btnSelect">
                            <option value="-1">请选择按钮类型</option>
                            <option value="playNode">全部播放</option>
                            <option value="more">更多精彩</option>
                            <option value="backNode">返回</option>
                        </select>
                    </span>
                </span>
            </li>
            <li>
                <span>
                    <label>节点 - 宽度： </label>
                    <input type="text" class="easyui-numberbox" value="" placeholder="" id="btnNodeWidth" name="width">
                </span>
                <span>
                    <label>节点 - 高度： </label>
                    <input type="text" class="easyui-numberbox" value="" placeholder="" id="btnNodeHeight" name="height">
                </span>
            </li>
            <li>
                <span>
                    <label>节点 - 左边距： </label>
                    <input type="text" class="easyui-numberbox" value="" placeholder="" id="btnNodeLeft" name="left">
                </span>
                <span>
                    <label>节点 - 上边距： </label>
                    <input type="text" class="easyui-numberbox" value="" placeholder="" id="btnNodeTop" name="top">
                </span>
            </li>
            <li>
                <span>
                    <label>节点 - 图片： </label>
                    <input type="text" class="input-text small-box" value="" placeholder="" id="btnNodeImg" name="img">
                </span>
            </li>
            <li class="automatic" hidden>
                <span>
                    <label>选择图片： </label>
                    <input type="hidden" id="btnImg"/>
                    <span class="btn-upload form-group">
                        <input class="input-text upload-url" type="text" name="uploadfile-2" readonly style="width:200px">
                        <a href="javascript:void();" class="btn btn-primary upload-btn"><i class="Hui-iconfont">&#xe642;</i> 选择图片</a>
                        <input type="file" multiple name="file-2" class="input-file" onchange="choosedFile(this, 'btn')">
                        <button type="button" class="btn btn-default radius" style="z-index: 3;" onclick="startTag()"> 开始标注 </button>
                    </span>
                </span>
            </li>
            <li>
                <button onclick="complete('btn');" class="btn btn-success radius" type="button"> 完成</button>
                <button onclick="closeDiv('btn');" class="btn btn-default radius" type="button"> 关闭</button>
            </li>
        </ul>
    </div>
    <div class="infoNode">
        <table class="table table-border table-bordered radius table-margin">
            <thead>
            <tr class="text-c">
                <th>歌曲Id</th>
                <th>歌曲名称</th>
                <th>是否免费</th>
                <th>节点 - 宽度</th>
                <th>节点 - 高度</th>
                <th>节点 - 左边距</th>
                <th>节点 - 上边距</th>
                <th>节点 - 选中图片</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody class="table-song">
            </tbody>
        </table>
        <table class="table table-border table-bordered radius table-margin">
            <thead>
            <tr class="text-c">
                <th>按钮类型</th>
                <th>节点 - 宽度</th>
                <th>节点 - 高度</th>
                <th>节点 - 左边距</th>
                <th>节点 - 上边距</th>
                <th>节点 - 选中图片</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody class="table-btn">
            </tbody>
        </table>
    </div>
    <div class="row cl form-div-center infoNode">
        <button onclick="saveSpecial();" class="btn btn-primary radius" type="button"><i class="Hui-iconfont">&#xe632;</i> 保存</button>
    </div>
    <div>
        <div id="canvas"></div>
        <div class="row cl form-div-center" hidden>
            <button class="btn btn-default radius" type="button" onclick="tagOver('complete')">完成</button>
            <button class="btn btn-default radius" type="button" onclick="tagOver('close')">关闭</button>
        </div>
    </div>
</div>
<script type="text/javascript" src="../lib/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="../lib/layer/2.4/layer.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/jquery.validate.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/validate-methods.js"></script>
<script type="text/javascript" src="../lib/jquery.validation/1.14.0/messages_zh.js"></script>
<script type="text/javascript" src="../static/h-ui/js/H-ui.min.js"></script>
<script type="text/javascript" src="../static/h-ui.admin/js/H-ui.admin.js"></script>
<script type="text/javascript" src="../lib/jquery-easyui-1.7.0/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../lib/ChinesePY.js"></script>
<script type="text/javascript" src="../lib/imageLabel/scripts/jquery.imageLabel.min.js"></script>
<script type="text/javascript" src="../lib/function.js"></script>
<script type="text/javascript">
    let currentType = "";
    let isDown = false;
    let nodes = [];
    let currentIdx = -1;
    let nodeIdx = 0;
    let diffX = 0;
    let diffY = 0;
    let editIdx = -1;
    $(function () {
        $("#songSelect").combobox({
            valueField: 'id',
            textField: 'text',
            loader: function (param, success, error) {
                $.ajax({
                    url: getUrl("song/getComboboxData"),
                    type: 'get',
                    dataType: 'json',
                    success: function (response) {
                        if (response) {
                            success(response);
                        }
                    }
                });
            },
            onLoadSuccess: function () {
                $(this).combobox("setValue", -1);
            }
        });
    });

    /**
     * 添加
     * @param type
     */
    function add(type) {
        currentType = type;
        switch (type) {
            case "song":
                $("#div-add-btn").hide();
                $("#div-add-song").show();
                break;
            case "btn":
                $("#div-add-song").hide();
                $("#div-add-btn").show();
                break;
            default:
                break;
        }
    }

    /**
     * 完成添加
     * @param type
     */
    function complete(type) {
        switch (type) {
            case "song":
                var songId = $("#songSelect").combobox('getValue');
                var songName = $("#songSelect").combobox('getText');
                var isFree = $("input[name='isFree']:checked").val();
                var songNodeWidth = $("#songNodeWidth").val();
                var songNodeHeight = $("#songNodeHeight").val();
                var songNodeLeft = $("#songNodeLeft").val();
                var songNodeTop = $("#songNodeTop").val();
                var songNodeImg = $("#songNodeImg").val();

                if (!songId || !songName || !songNodeWidth || !songNodeHeight
                    || !songNodeLeft || !songNodeTop || !songNodeImg) {
                    $.Huimodalalert("无效的输入", 1000);
                    return false;
                }
                var index = editIdx;
                if(editIdx == -1) {
                    index = $(".table-song").children().length;
                }
                var html = '';
                html += '<tr class="text-c">';
                html += '   <td><input name="songId" value="' + songId + '" hidden="hidden"/><span>' + songId + '</span></td>';
                html += '   <td><span>' + songName + '</span></td>';
                html += '   <td><input name="freeValue" value="' + isFree + '" hidden="hidden"/><span>' + (isFree == 1 ? "是" : "否") + '</span></td>';
                html += '   <td><input name="width" value="' + songNodeWidth + '" hidden="hidden"/><span>' + songNodeWidth + '</span></td>';
                html += '   <td><input name="height" value="' + songNodeHeight + '" hidden="hidden"/><span>' + songNodeHeight + '</span></td>';
                html += '   <td><input name="left" value="' + songNodeLeft + '" hidden="hidden"/><span>' + songNodeLeft + '</span></td>';
                html += '   <td><input name="top" value="' + songNodeTop + '" hidden="hidden"/><span>' + songNodeTop + '</span></td>';
                html += '   <td><input name="img" value="' + songNodeImg + '" hidden="hidden"/><span>' + songNodeImg + '</span></td>';
                html += '   <td>';
                html += '       <button onclick="deleteTd(this);" class="btn btn-secondary radius" type="button"> 删除 </button>';
                html += '       <button onclick="editTd(this, ' + index + ');" class="btn btn-secondary radius" type="button"> 编辑 </button>';
                html += '       <button onclick="moveTd(this, \'top\');" class="btn radius" type="button">置顶</button>';
                html += '       <button onclick="moveTd(this, \'up\');" class="btn radius" type="button">上移</button>';
                html += '       <button onclick="moveTd(this, \'down\');" class="btn radius" type="button">下移</button>';
                html += '       <button onclick="moveTd(this, \'bottom\');" class="btn radius" type="button">置底</button>';
                html += '   </td>';
                html += '</tr>';
                if(editIdx == -1) {
                    $(".table-song").append(html);
                } else {
                    $(".table-song").children().eq(editIdx).replaceWith(html);
                }
                $("#songSelect").combobox('setValue', -1);
                $(":radio[name='isFree'][value='0']").prop("checked", "checked");
                editIdx = -1;
                break;
            case "btn":
                var nodeType = $("#btnSelect").val();
                var nodeTypeText = $("#btnSelect").find("option:selected").text();
                var btnNodeWidth = $("#btnNodeWidth").val();
                var btnNodeHeight = $("#btnNodeHeight").val();
                var btnNodeLeft = $("#btnNodeLeft").val();
                var btnNodeTop = $("#btnNodeTop").val();
                var btnNodeImg = $("#btnNodeImg").val();

                if (nodeType == -1 || !btnNodeWidth || !btnNodeHeight
                    || !btnNodeLeft || !btnNodeTop || !btnNodeImg) {
                    $.Huimodalalert("无效的输入", 1000);
                    return false;
                }

                var btnHtml = '';
                btnHtml += '<tr class="text-c">';
                btnHtml += '   <td><input name="nodeType" value="' + nodeType + '" hidden="hidden"/><span>' + nodeTypeText + '</span></td>';
                btnHtml += '   <td><input name="width" value="' + btnNodeWidth + '" hidden="hidden"/><span>' + btnNodeWidth + '</span></td>';
                btnHtml += '   <td><input name="height" value="' + btnNodeHeight + '" hidden="hidden"/><span>' + btnNodeHeight + '</span></td>';
                btnHtml += '   <td><input name="left" value="' + btnNodeLeft + '" hidden="hidden"/><span>' + btnNodeLeft + '</span></td>';
                btnHtml += '   <td><input name="top" value="' + btnNodeTop + '" hidden="hidden"/><span>' + btnNodeTop + '</span></td>';
                btnHtml += '   <td><input name="img" value="' + btnNodeImg + '" hidden="hidden"/><span>' + btnNodeImg + '</span></td>';
                btnHtml += '   <td>';
                btnHtml += '       <button onclick="deleteTd(this);" class="btn btn-secondary radius" type="button"> 删除 </button>';
                btnHtml += '       <button onclick="moveTd(this, \'top\');" class="btn radius" type="button">置顶</button>';
                btnHtml += '       <button onclick="moveTd(this, \'up\');" class="btn radius" type="button">上移</button>';
                btnHtml += '       <button onclick="moveTd(this, \'down\');" class="btn radius" type="button">下移</button>';
                btnHtml += '       <button onclick="moveTd(this, \'bottom\');" class="btn radius" type="button">置底</button>';
                btnHtml += '   </td>';
                btnHtml += '</tr>';
                $(".table-btn").append(btnHtml);
                $("#btnSelect").val(-1);
                break;
            default:
                break;
        }
        $(".div-add").find("input[type='text']").val("");
    }

    /**
     * 关闭添加表格
     * @param type
     */
    function closeDiv(type) {
        let divId = "div-add-" + type;
        $("#" + divId).hide();
    }

    /**
     * 删除一行
     * @param event
     */
    function deleteTd(event) {
        $(event).parents("tr").remove();
    }

    /**
     * 保存专题
     */
    function saveSpecial() {
        var title = $("#title").val();
        var titleAbbr = $("#titleAbbr").val();
        var isp = $("#ips").val();
        var active = $("#active").val();
        var ctype = $("#ctype").val();
        var csort = $("#csort").numberbox('getValue');
        var songs = [];
        var btns = [];

        var songList = $(".table-song").children("tr");
        $.each(songList, function (idx, item) {
            var song = {};
            var nodeInfo = {};
            song.songId = $(item).find("input[name='songId']").val();
            var freeValue = parseInt($(item).find("input[name='freeValue']").val());
            if (freeValue == 0) {
                song.isFree = 1;
            } else if (freeValue == 1) {
                song.isFree = 0;
            }
            nodeInfo.width = $(item).find("input[name='width']").val();
            nodeInfo.height = $(item).find("input[name='height']").val();
            nodeInfo.left = $(item).find("input[name='left']").val();
            nodeInfo.top = $(item).find("input[name='top']").val();
            nodeInfo.imgName = $(item).find("input[name='img']").val();
            song.nodeInfo = nodeInfo;
            songs.push(song);
        });

        var btnList = $(".table-btn").children();
        $.each(btnList, function (idx, item) {
            var btn = {};
            var nodeInfo = {};
            btn.nodeType = $(item).find("input[name='nodeType']").val();
            nodeInfo.width = $(item).find("input[name='width']").val();
            nodeInfo.height = $(item).find("input[name='height']").val();
            nodeInfo.left = $(item).find("input[name='left']").val();
            nodeInfo.top = $(item).find("input[name='top']").val();
            nodeInfo.imgName = $(item).find("input[name='img']").val();
            btn.nodeInfo = nodeInfo;
            btns.push(btn);
        });

        var param = {
            title: title,
            titleAbbr: titleAbbr,
            active: active,
            ctype: ctype,
            isp: isp,
            csort: csort,
            songs: JSON.stringify(songs),
            btns: JSON.stringify(btns)
        };

        $.ajax({
            url: getUrl("autoDeploy/start"),
            type: 'post',
            data: param,
            dataType: 'json',
            success: function (response) {
                $.Huimodalalert(response.msg, 1000);
            }
        });
    }

    /**
     * 移动节点
     * @param event
     * @param direction
     */
    function moveTd(event, direction) {
        let current = $(event).parents("tr");
        let tbody = $(event).parents("tbody");
        switch (direction) {
            case "top":
                current.prependTo(tbody);
                break;
            case "up":
                current.insertBefore(current.prev());
                break;
            case "down":
                current.insertAfter(current.next());
                break;
            case "bottom":
                current.appendTo(tbody);
                break;
            default:
                break;
        }
    }

    /**
     * 选择填写节点信息的方式
     * @param type
     */
    function changeInput(type) {
        $('input:radio[name=type]').attr('checked', false);
        switch (type) {
            case 0:
                $("input:radio[name='type']")[1].checked = true;
                $(".automatic").show();
                $(".manual").hide();
                break;
            case 1:
                $("input:radio[name='type']")[0].checked = true;
                $(".manual").show();
                $(".automatic").hide();
                break;
            default:
                break;
        }
    }

    /**
     * 打开图片标注层
     * @param event
     * @param type
     */
    function choosedFile(event, type) {
        let file = $(event).val();
        if (file) {
            let fileName = file.substring(file.lastIndexOf("\\") + 1);
            let date = new Date();
            let year = date.getFullYear();
            let month = date.getMonth() + 1;
            let yearAndMonth = year;
            if (month < 10) {
                yearAndMonth += "-0" + month;
            } else {
                yearAndMonth += "-" + month;
            }
            let title = $("#title").val();
            $("#" + type + "Img").val("/img/" + yearAndMonth + "/" + title + "/" + fileName);
            $(event).prev().val(fileName);
        }
    }

    /**
     * 开始标记
     */
    function startTag() {
        // 替换画布背景并显示画布
        let imgUrl = $("#" + currentType + "Img").val();
        $("#canvas").css("background", "url('" + imgUrl + "')");
        // 监听鼠标按下
        let s = "";
        $("#canvas").mousedown(function (e) {
            let node = {};
            s = $('<div class="imageLabel-imgdrop"></div>');
            diffX = e.offsetX - e.clientX;
            diffY = e.offsetY - e.clientY;
            node.index = nodeIdx;
            node.left = e.offsetX;
            node.top = e.offsetY;
            nodes.push(node);
            currentIdx = node.index;
            isDown = true;
            s.css({
                left: e.clientX,
                top: e.clientY
            });
            $("#canvas").append(s);
        });
        // 监听鼠标移动
        $("#canvas").mousemove(function (e) {
            if (isDown) {
                // 画出遮罩框
                let width = Math.abs(e.clientX + diffX - nodes[currentIdx].left);
                let height = Math.abs(e.clientY + diffY - nodes[currentIdx].top);
                $(".imageLabel-imgdrop").eq(currentIdx).css({
                    width: width,
                    height: height
                });
            }
        });
        // 监听鼠标松开
        $("#canvas").mouseup(function (e) {
            if (isDown) {
                let width = Math.abs(e.clientX + diffX - nodes[currentIdx].left);
                let height = Math.abs(e.clientY + diffY - nodes[currentIdx].top);
                if (width <= 10 && height <= 10) {
                    nodes.splice(currentIdx, 1);
                } else {
                    nodes[currentIdx].width = width;
                    nodes[currentIdx].height = height;
                    nodeIdx++;
                }
                currentIdx = -1;
                isDown = false;
            }
        });
        $("#canvas").next().show();
        $(".infoNode").hide();
    }

    /**
     * 标记结束
     * @param type
     */
    function tagOver(type) {
        $("#canvas").next().hide();
        $(".infoNode").show();
        if (type == 'complete') {
            // 填入节点信息
        }
    }

    /**
     * 修改节点信息
     * @param event
     */
    function editTd(event, index) {
        editIdx = index;
        let row = $(event).parents("tr");
        let songId = row.find("input[name='songId']").val();
        let freeValue = row.find("input[name='freeValue']").val();
        let img = row.find("input[name='img']").val();
        $("#div-add-song").show();
        $("#div-add-btn").hide();
        $("#songSelect").combobox('setValue', songId);
        $(":radio[name='isFree']").removeAttr("checked");
        $(":radio[name='isFree'][value='" + freeValue + "']").prop("checked", "checked");
        $("#songNodeImg").val(img);
    }
</script>
</body>
</html>